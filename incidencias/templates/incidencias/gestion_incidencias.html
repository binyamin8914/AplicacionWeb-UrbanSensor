{% extends "core/base.html" %}
{% block title %}Gestión de Incidencias{% endblock %}

{% block content %}
<div class="container mt-4">

    {# Título adaptado al perfil #}
    {% if group_name == "Territorial" %}
        <h1 class="mb-3">Mis incidencias</h1>
    {% else %}
        <h1 class="mb-3">Gestión de Incidencias</h1>
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mb-3">
        
        <div class="d-flex">
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-filter-left me-1"></i>
                    {% if request.GET.estado %}
                        {{ request.GET.estado|capfirst }}
                    {% else %}
                        Estado
                    {% endif %}
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <a class="dropdown-item {% if not request.GET.estado %}active{% endif %}" href="{% url 'gestion_incidencias' %}">
                            Todos los Estados
                        </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    
                    <li><a class="dropdown-item" href="?estado=abierta">Abierta</a></li>
                    <li><a class="dropdown-item" href="?estado=derivada">Derivada</a></li>
                    <li><a class="dropdown-item" href="?estado=proceso">En proceso</a></li>
                    <li><a class="dropdown-item" href="?estado=finalizada">Finalizada</a></li>
                    <li><a class="dropdown-item" href="?estado=rechazada">Rechazada</a></li>
                </ul>
            </div>
        </div>

        {% if group_name == "Territorial" %}
            <a href="{% url 'crear_incidencia' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle-fill me-2"></i>Crear Nueva Incidencia
            </a>
        {% endif %}
        
    </div>

    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Tipo</th>
                        <th>Dirección</th>
                        <th>Departamento</th>
                        <th>Estado</th>
                        <th style="width: 260px;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                {% for inc in incidencias %}
                    <tr>
                        <td>{{ inc.id }}</td>
                        <td>{{ inc.encuesta.tipo_incidencia.nombre }}</td>
                        <td>
                            {{ inc.encuesta.tipo_incidencia.departamento.direccion.nombre|default:"-" }}
                        </td>
                        <td>{{ inc.encuesta.tipo_incidencia.departamento.nombre|default:"-" }}</td>
                        <td>
                            {# Badge de Bootstrap según estado #}
                            {% if inc.estado == "abierta" %}
                                <span class="badge bg-success">Abierta</span>
                            {% elif inc.estado == "derivada" %}
                                <span class="badge bg-primary">Derivada</span>
                            {% elif inc.estado == "proceso" %}
                                <span class="badge bg-warning text-dark">En proceso</span>
                            {% elif inc.estado == "finalizada" %}
                                <span class="badge bg-secondary">Finalizada</span>
                            {% elif inc.estado == "rechazada" %}
                                <span class="badge bg-danger">Rechazada</span>
                            {% else %}
                                {{ inc.get_estado_display }}
                            {% endif %}
                        </td>
                        <td>
                            {# Botón de ver siempre disponible #}
                            <a href="{% url 'incidencia_detalle' inc.id %}" class="btn btn-sm btn-outline-secondary">
                                Ver
                            </a>

                            {# Territorial puede editar/eliminar sus propias incidencias #}
                            {% if group_name == "Territorial" and inc.territorial == request.user %}
                                <a href="{% url 'editar_incidencia' inc.id %}" class="btn btn-sm btn-info text-white">
                                    Editar
                                </a>
                                <a href="{% url 'eliminar_incidencia' inc.id %}" class="btn btn-sm btn-danger">
                                    Eliminar
                                </a>
                            {% endif %}

                            {# Lógica para otros roles (Derivar/Finalizar) sigue aquí igual... #}
                            {% if group_name == "Departamento" %}
                                <a href="{% url 'derivar_incidencia' inc.id %}" class="btn btn-sm btn-warning">
                                    Derivar
                                </a>
                            {% endif %}
                            
                            {% if group_name == "Cuadrilla" and inc.cuadrilla_id %}
                                {% if inc.cuadrilla.encargado_id == request.user.id %}
                                    <form action="{% url 'finalizar_incidencia' inc.id %}" method="post" class="d-inline">
                                        {% csrf_token %}
                                        <button class="btn btn-sm btn-success" type="submit">Finalizar</button>
                                    </form>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted p-4 fst-italic">
                            No hay incidencias registradas con este filtro.
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}